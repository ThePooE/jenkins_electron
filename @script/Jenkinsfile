#!groovy
import groovy.json.*
import hudson.model.*

node {
    /** Downloading Stage */
    //def job = Jenkins.instance.getItem("jenkin_groovy")
    stage 'Download'
    checkout scm
    def mvnHome = tool 'M3'
    //bat "mvn -B -Dmaven.test.failure.ignore verify"

    /** Setting-up Stage */
    stage 'Setup'
    bat 'npm run package-properties'
    def file = readFile 'package-properties.json'
    def json = new JsonSlurperClassic().parseText(file);
    echo file
    currentBuild.displayName = 'v' + json.version + ' - ' + json.platform + env.BUILD_ID
    bat 'npm uninstall *'

    /** Building Stage */
    stage 'Build'
    bat 'npm install'

    /** Testing Stage */
    stage 'Test'
    bat 'npm run e2e'
    bat 'npm run coverage'

    /** Packaging Stage */
    stage 'Package'
    bat 'npm run packWin'
    archiveArtifacts artifacts: '**', onlyIfSuccessful: true
    deleteDir()
}